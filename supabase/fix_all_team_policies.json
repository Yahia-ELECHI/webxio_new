{
  "query": "-- Ce script est destiné à être exécuté directement dans la console SQL de Supabase\n-- pour corriger toutes les politiques RLS liées aux équipes\n\n-- 1. Suppression de toutes les politiques existantes qui pourraient causer des récursions\n-- Pour la table teams\nDROP POLICY IF EXISTS \"teams_select_policy\" ON public.teams;\nDROP POLICY IF EXISTS \"teams_insert_policy\" ON public.teams;\nDROP POLICY IF EXISTS \"teams_update_policy\" ON public.teams;\nDROP POLICY IF EXISTS \"teams_delete_policy\" ON public.teams;\n\n-- Pour la table team_members\nDROP POLICY IF EXISTS \"team_members_select_policy\" ON public.team_members;\nDROP POLICY IF EXISTS \"team_members_insert_policy\" ON public.team_members;\nDROP POLICY IF EXISTS \"team_members_update_policy\" ON public.team_members;\nDROP POLICY IF EXISTS \"team_members_update_own_policy\" ON public.team_members;\nDROP POLICY IF EXISTS \"team_members_delete_policy\" ON public.team_members;\n\n-- Pour la table team_projects\nDROP POLICY IF EXISTS \"team_projects_select_policy\" ON public.team_projects;\nDROP POLICY IF EXISTS \"team_projects_insert_policy\" ON public.team_projects;\nDROP POLICY IF EXISTS \"team_projects_delete_policy\" ON public.team_projects;\n\n-- 2. Création de nouvelles politiques sans récursion\n-- Pour la table teams\nCREATE POLICY \"teams_select_policy\" \nON public.teams FOR SELECT \nUSING (\n  -- Permet à l'utilisateur de voir les équipes qu'il a créées\n  created_by = auth.uid()\n);\n\nCREATE POLICY \"teams_insert_policy\" \nON public.teams FOR INSERT \nWITH CHECK (created_by = auth.uid());\n\nCREATE POLICY \"teams_update_policy\" \nON public.teams FOR UPDATE \nUSING (created_by = auth.uid());\n\nCREATE POLICY \"teams_delete_policy\" \nON public.teams FOR DELETE \nUSING (created_by = auth.uid());\n\n-- Pour la table team_members\nCREATE POLICY \"team_members_select_policy\" \nON public.team_members FOR SELECT \nUSING (\n  -- Permet à l'utilisateur de voir ses propres enregistrements\n  user_id = auth.uid()\n  -- Ou les enregistrements des équipes qu'il a créées\n  OR team_id IN (\n    SELECT id FROM public.teams WHERE created_by = auth.uid()\n  )\n);\n\nCREATE POLICY \"team_members_insert_policy\" \nON public.team_members FOR INSERT \nWITH CHECK (\n  -- Permet à l'utilisateur d'insérer des membres dans les équipes qu'il a créées\n  team_id IN (\n    SELECT id FROM public.teams WHERE created_by = auth.uid()\n  )\n);\n\nCREATE POLICY \"team_members_update_policy\" \nON public.team_members FOR UPDATE \nUSING (\n  -- Permet à l'utilisateur de mettre à jour les membres des équipes qu'il a créées\n  team_id IN (\n    SELECT id FROM public.teams WHERE created_by = auth.uid()\n  )\n);\n\nCREATE POLICY \"team_members_update_own_policy\" \nON public.team_members FOR UPDATE \nUSING (user_id = auth.uid());\n\nCREATE POLICY \"team_members_delete_policy\" \nON public.team_members FOR DELETE \nUSING (\n  -- Permet à l'utilisateur de supprimer des membres des équipes qu'il a créées\n  team_id IN (\n    SELECT id FROM public.teams WHERE created_by = auth.uid()\n  )\n);\n\n-- Pour la table team_projects\nCREATE POLICY \"team_projects_select_policy\" \nON public.team_projects FOR SELECT \nUSING (\n  -- Permet à l'utilisateur de voir les projets des équipes qu'il a créées\n  team_id IN (\n    SELECT id FROM public.teams WHERE created_by = auth.uid()\n  )\n  -- Ou les projets des équipes auxquelles il appartient\n  OR team_id IN (\n    SELECT team_id FROM public.team_members WHERE user_id = auth.uid() AND status = 'active'\n  )\n);\n\nCREATE POLICY \"team_projects_insert_policy\" \nON public.team_projects FOR INSERT \nWITH CHECK (\n  -- Permet à l'utilisateur d'insérer des projets dans les équipes qu'il a créées\n  team_id IN (\n    SELECT id FROM public.teams WHERE created_by = auth.uid()\n  )\n);\n\nCREATE POLICY \"team_projects_delete_policy\" \nON public.team_projects FOR DELETE \nUSING (\n  -- Permet à l'utilisateur de supprimer des projets des équipes qu'il a créées\n  team_id IN (\n    SELECT id FROM public.teams WHERE created_by = auth.uid()\n  )\n);"
}
